# AWS 서버 환경을 만들어 보자 - AWS EC2
외부에서 본인이 만든 서비스에 접근하려면 **24시간 작동하는 서버**가 필수이다.   
24시간 작동하는 서버에는 3가지 선택지가 있다.
1. 집에 PC를 24시간 구동시킨다.
2. 호스팅 서비스를 이용한다.
3. 클라우드 서비스를 이용한다.

> 클라우드 서비스는 쉽게 말하면 인터넷(클라우드)을 통해 서버, 스토리지, 데이터베이스, 네트워크, 소프트웨어, 모니터링 등의 컴퓨팅 서비스를 제공하는 것이다.   
> 예를 들어 AWS의 EC2는 서버 장비를 대여하는 것이지만, 실제로는 그 안의 로그 관리, 모니터링, 하드웨어 교체, 네트워크 관리 등을 기본적으로 지원하고 있다.

이러한 클라우드에는 몇가지 형태가 있다.
1. Infrastructure as a Service(IaaS, 아이아스, 이에스)
    - 기존 물리장비를 미들웨어와 함께 묶어둔 추상화 서비스이다.
    - 가상머신, 스토리지, 네트워크, 운영체제 등의 IT 인프라를 대여해 주는 서비스라고 보면 된다.
    - AWS의 EC2, S3등
2. Platform as a Service(PaaS, 파스)
    - 앞에서 언급한 IaaS에서 한 번 더 추상화한 서비스이다.
    - 한 번 더 추상화했기 때문에 많은 기능이 자동화 되어있다.
    - AWS의 Beanstalk, Heroku
3. Software as a Service(SaaS, 사스)
    - 소프트웨어 서비스를 이야기한다.
    - 구글 드라이브, 드랍박스, 와탭 등

이 책에서 진행하는 모든 AWS 서비스는 IaaS를 사용한다.
- AWS 초보자 일 때는 직접 하나씩 다 다뤄보는 것이 공부하는데 도움이 된다.

## 6.1 AWS 회원가입
1. [AWS 공식 사이트](https://aws.amazon.com/ko/)로 이동한 뒤 **무료 계정 만들기**를 선택한다.
2. 신규로 생성할 AWS 계정 정보를 등록한다.
    - 이메일 주소
    - 암호
    - 암호 확인
    - AWS 계정 이름
    - 영문 주소
    - Master 혹은 Visa 카드의 정보
    - 등등..

## 6.2 EC2 인스턴스 생성하기
EC2는 AWS에서 제공하는 성능, 용량 등을 유동적으로 사용할 수 있는 서버이다.   
AWS에서 무료로 제공하는 프리티어 플랜에서는 EC2 사용에 다음과 같은 제한이 있다.
- 사양이 t2.micro만 가능하다.
- 월 750시간의 제한이 있다. 초과하면 비용이 부과된다.
1. EC2를 만들기 전에, 본인의 리전을 확인해 보자. 서울로 리전이 설정되어 있지 않다면 서울로 바꾼다.
   - 리전이란 AWS의 서비스가 구동될 지역을 이야기한다.
   - AWS는 도시별로 클라우드 센터를 지어 해당 센터에서 구축된 가상머신들을 사용할 수 있다. 이걸 리전이라고 부른다.
   - 국내에서 서비스 한다면 무조건 서울 리전을 선택하면 된다.
2. EC2 페이지로 가서 인스턴스 시작버튼을 누른다.
3. 첫 단계는 AMI(Amazon Machine Image, 아마존 머신 이미지)를 선택하는 것이다. 여기서는 **Amazon Linux AMI**를 선택한다.
- AMI는 EC2 인스턴스를 시작하는데 필요한 정보를 **이미지로 만들어 둔 것**을 이야기한다.
- 인스턴스라는 가상머신에 운영체제 등을 설치할 수 있게 구워 넣은 이미지로 생각하면 된다.
4. 다음 단계는 인스턴스 유형을 선택하는 단계이다. 프리티어로 표기된 **t2.micro**를 선택한다.
5. 다음 단계는 세부정보 구성이다. 여기서는 혼자서 1대의 서버만 사용하니 별다른 설정을 하지 않고 넘어간다.
6. 다음 단계는 스토리지 선택이다. 서버의 용량을 얼마나 정할지 선택하는 단계이다. **30GB까지 프리티어로 가능**하다.
7. 다음 단계는 태그 추가이다. 여러 인스턴스가 있을 경우 이를 태그별로 구분하면 검색이나 그룹 짓기 편하므로 여기서 본인 서비스의 인스턴스를 나타낼 수 있는 값으로 등록한다.
8. 다음 단계는 보안 그룹이다. 보안 그룹은 **방화벽**을 이야기한다. '**서버로 80포트 외에는 허용하지 않는다**'는 역할을 하는 방화벽이 AWS에서는 보안 그룹으로 사용된다.
- 포트항목이 22인 경우는 **AWS EC2에 터미널로 접속**할 때를 이야기 한다.
    + 보안은 언제나 높을수록 좋으니 pem키 관리와 **지정된 IP에서 ssh 접속이 가능**하도록 구성하는 것이 안전하다.
- 현재 프로젝트의 기본포트인 8080을 추가하고 **검토 및 시작**버튼을 클릭한다.
9. 인스턴스로 접근하기 위해서는 pem 키가 필요하다. pem 키가 없다면 새로 발급 받고, 기존에 있는 pem 키가 있다면 그것을 사용하면 된다.
- 일종의 마스터키기이므로 절대 유출해서는 안된다.

인스턴스도 결국 하나의 서버이기 때문에 IP가 존재한다.   
인스턴스 생성시 항상 새 IP를 할당하는데, 한 가지 조건이 더 있다.  
같은 인스턴스를 중지하고 **다시 시작할 때도 새 IP가 할당**된다.   
이렇게 되면 매번 접속해야하는 IP가 변경되어서 PC에서 접근할 때 마다 IP주소를 확인해야한다. 굉장히 번거로우므로 인스턴스의 IP가 **매번 변경되지 않고 고정 IP를 가지게** 해야한다.
### EIP(Elastic IP)할당
AWS에서 고정 IP를 EIP라고 한다.
1. 왼쪽 카테고리에서 **네트워크 및 보안**에서 **탄력적 IP**버튼을 클릭한다.
2. **탄력적 IP 주소 할당**버튼을 클릭해서 바로 **할당**버튼을 클릭한다.
3. 방금 생성한 탄력적 IP와 방금 생성한 EC2 주소를 연결한다. **방금 생성한 탄력적 IP를 확인**하고, 페이지 위에 있는 **작업**버튼을 누르고 **탄력적 IP 주소 연결**메뉴를 선택한다. 
4. 주소 연결을 위해 생성한 EC2 이름과 IP를 선택하고 **연결**버튼을 클릭한다.
5. 연결이 완료되면 왼쪽 카테고리에 있는 **인스턴스**탭을 클릭해서 다시 **인스턴스 목록**페이지로 이동한다.
6. 해당 인스턴스의 **퍼블릭, 탄력적 IP**가 모두 잘  연결되었는지 확인한다.
> 주의할 점   
> 탄력적 IP는 생성하고 EC2서버에 연결하지 않으면 비용이 발생한다.   
> 즉, 생성한 탄력적 IP는 무조건 EC2에 바로 연결해야하며 만약 더는 사용할 인스턴스가 없을 때도 탄력적 IP를 삭제해야 한다.
## 6.3 EC2 서버에 접속하기
Mac & Linux 방법
> 오랜 시간 접속이 안 되거나, 권한이 없어서 안 된다고 메시지가 나온다면 다음과 같이 확인해 보는 것이 좋다.
> 1. HostName 값이 정확히 탄력적 IP로 되어있는지 확인
> 2. EC2 인스턴스가 running 상태인지 확인
> 3. EC2 인스턴스의 보안그룹 -> 인바운드 규칙에서 현재 본인의 IP가 등록되어 있는지 확인

AWS와 같은 외부 서버로 SSH 접속을 하려면 매번 다음과 같이 긴 명령어를 입력해야 한다.
> `ssh -i pem 키 위치 EC2의 탄력적 IP주소`

쉽게 ssh접속을 하는 방법으로 설정해보자.
1. 키페어 pem 파일을 ~/.ssh/로 복사한다.
> cp pem 키를 내려받은 위치 ~/.ssh/  
> ex) `cp ~/Documents/Key.pem ~/.ssh/`
2. 복사가 되었는지 확인한 뒤, pem 키의 권한을 변경한다.
> chmod 600 ~/.ssh/pem키 이름   
> `chmod 600 ~/.ssh/Key.pem`
3. 권한을 변경하였다면 pem키가 있는 `~/.ssh/`디렉토리에 config 파일을 생성한다.
> `vim ~/.ssh/config`
4. 다음과 같이 작성
```config
Host WebServer(본인이 원하는 서비스 명)
    HostName xxx.xxx.xxx.xxx(탄력적 IP 주소)
    User ec2-user
    IdentityFile ~/.ssh/Key.pem(pem 키 위치)
```
5. config파일에 실행 권한을 준다.
> `chmod 700 ~/.ssh/config`
6. `ssh config에 등록한 서비스명`으로 접속해본다.
> `ssh WebServer`

## 6.4 아마존 리눅스 서버 생성 시 꼭 해야할 설정들
1. Java 11 설치
2. 타임존 변경 : 기본 서버의 시간은 미국 시간대이다. 한국 시간대가 되어야만 우리가 사용하는 시간이 모두 한국 시간으로 등록되고 사용된다.
3. 호스트네임 변경 : 현재 접속한 서버의 별명을 동록한다. 실무에서는 한 대의 서버가 아닌 수십 대의 서버가 작동되는데, IP만으로 어떤 서버가 어떤 역할을 하는지 알수 없다. 이를 구분하기 위해 보통 호스트 네임을 필수로 등록한다.

### 1. 자바 11 설치 
> 책에서는 자바 8로 진행하였다.   
> [아마존 리눅스 2용 Amazon Corretto 11 설치 지침](https://docs.aws.amazon.com/ko_kr/corretto/latest/corretto-11-ug/amazon-linux-install.html) 참고
1. sudo yum install java-11-amazon-corretto명령어를 통해서 자바 11 을 설치한다.
2. `java -version`을 통해서 자바 버젼을 확인한다.
```
[ec2-user@ip-... ~]$ java -version
openjdk version "11.0.10" 2021-01-19 LTS
OpenJDK Runtime Environment Corretto-11.0.10.9.1 (build 11.0.10+9-LTS)
OpenJDK 64-Bit Server VM Corretto-11.0.10.9.1 (build 11.0.10+9-LTS, mixed mode)
```
### 2. 타임존 변경
EC2 서버의 기본 타임존은 UTC이다. 이는 세계 표준 시간으로 한국의 시간대가 아니다.    
즉, **한국의 시간과는 9시간 차이**가 발생한다. 이렇게 되면 서버에서 수행되는 Java 애플리케이션에서 생성되는 시간도 모두 9시간 씩 차이가 나게 된다.
1. 아래의 명령어를 입력한다. 
```
sudo rm /etc/localtime
sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime
```
2. 그 후 `date`를 통해서 시간이 변경되었는지 확인한다.
```
[ec2-user@ip-... ~]$ date
2021. 02. 26. (금) 11:13:40 KST
```
3. root 계정으로 변환 한뒤 `etc/sysconfig/clock`을 변경한다.   
```
# root 계정으로 변환
sudo su - root
```
```
# vim을 이용해서 입력
ZONE="Asia/Seoul"
UTC=true
```
4. 재부팅이 끝나고 다시 접속해서 확인한다.
### 3. Hostname 변경
여러 서버를 관리 중일 경우 **IP만으로 어떤 서비스의 서버인지**확인이 어렵다.
> [Amazon Linux 인스턴스에서 호스트 이름 변경](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/set-hostname.html) 참고
1. hostnamectl 명령으로 호스트 이름을 설정하여 원하는 시스템 호스트 이름을 반영합니다(예: webserver).
```
sudo hostnamectl set-hostname webserver.localdomain
```
2. 선호하는 텍스트 편집기로 /etc/hosts 파일을 열고 127.0.0.1로 시작되는 항목을 아래 예제와 일치하도록 변경합니다. 원하는 호스트 이름을 대신 입력하면 됩니다.
```
127.0.0.1 webserver.localdomain webserver localhost4 localhost4.localdomain4
```
3. 인스턴스를 재부팅하여 새 호스트 이름을 적용합니다.
```
sudo reboot
```
4. 인스턴스에 로그인하고 호스트 이름이 업데이트되었는지 확인합니다. 프롬프트에 새 호스트 이름이 첫 번째 "."까지 표시되어야 하고, hostname 명령이 정규화된 도메인 이름을 표시해야 합니다.
```
[ec2-user@webserver ~]$ hostname
webserver.localdomain
```
5. `curl 등록한 호스트 이름`으로 확인
```
# /etc/hosts 에 등록 실패한 경우
[ec2-user@webserver ~]$ curl asdf
curl: (6) Could not resolve host: asdf
# /etc/hosts 에 등록 성공한 경우
[ec2-user@webserver ~]$ curl webserver
curl: (7) Failed to connect to webserver port 80: Connection refused
# 아직 80포트로 실행된 서비스가 없음을 의미한다.
```